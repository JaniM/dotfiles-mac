#!/usr/bin/env zsh
#
set -euo pipefail

dotfiles="$(realpath $(dirname $0))"
cd $dotfiles

# Install hpmebrew if it doesn't exist already
if [[ "$(uname)" == "Darwin" ]]; then
  if ! type brew > /dev/null; then
    echo "Installing brew"
    /bin/bash -c "$(curl -fsSL https://raw.githubusercontent.com/Homebrew/install/HEAD/install.sh)"
  fi
fi

if ! type nix-channel > /dev/null; then
  echo "Installing nix"
  sh <(curl -L https://nixos.org/nix/install)
  exit 0
fi

if ! type home-manager > /dev/null; then
  echo "Installing home-manager"
  nix-channel --add https://nixos.org/channels/nixpkgs-unstable unstable
  nix-channel --add https://github.com/nix-community/home-manager/archive/master.tar.gz home-manager
  nix-channel --update
  nix-shell '<home-manager>' -A install

  rm -rf ~/.config/home-manager
  ln -s $dotfiles ~/.config/home-manager
fi

home-manager switch

