#!/usr/bin/env zsh
#
set -euo pipefail

dotfiles="$(realpath $(dirname $0))"
cd $dotfiles

# Install hpmebrew if it doesn't exist already
if [[ "$(uname)" == "Darwin" ]]; then
  if ! type brew > /dev/null; then
    echo "Installing brew"
    /bin/bash -c "$(curl -fsSL https://raw.githubusercontent.com/Homebrew/install/HEAD/install.sh)"
  fi
fi

if ! type nix-channel > /dev/null; then
  echo "Installing nix"
  sh <(curl -L https://nixos.org/nix/install)
  exit 0
fi

if ! type darwin-rebuild > /dev/null; then
  echo "Installing darwin-rebuild"
  nix run nix-darwin -- switch --flake $dotfiles
  exit 0
fi

darwin-rebuild switch --flake $dotfiles

